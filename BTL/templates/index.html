<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RASFF Logic Inference System - An To√†n Th·ª±c Ph·∫©m & ChƒÉn Nu√¥i</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="wrapper">
        <!-- ==================== SIDEBAR ==================== -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üîç RASFF INFERENCE</h1>
                <p>An To√†n Th·ª±c Ph·∫©m & ChƒÉn Nu√¥i</p>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active" data-tab="upload">
                    <span>üì§</span>
                    <span>T·∫£i File</span>
                </div>
                <div class="nav-item" data-tab="search">
                    <span>üîé</span>
                    <span>T√¨m Lu·∫≠t</span>
                </div>
                <div class="nav-item" data-tab="inference">
                    <span>üß†</span>
                    <span>Suy Di·ªÖn</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <p>¬© 2025 RASFF System</p>
            </div>
        </div>

        <!-- ==================== MAIN CONTENT ==================== -->
        <div class="main-content">

            <!-- ===== TAB 1: T·∫¢I FILE ===== -->
            <div class="tab-pane active" id="upload-tab">
                <div class="tab-header">
                    <h2>üì§ T·∫£i File Excel</h2>
                </div>

                <div class="tab-content">
                    <div class="upload-container">
                        <div class="upload-area" id="uploadArea">
                            <i>üìã</i>
                            <h3>K√©o file Excel v√†o ƒë√¢y</h3>
                            <p>ho·∫∑c</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" hidden>
                            <button class="btn-upload" id="uploadBtn">
                                <span>Ch·ªçn File</span>
                            </button>
                        </div>

                        <div class="upload-status" id="uploadMessage"></div>
                    </div>
                </div>
            </div>

            <!-- ===== TAB 2: T√åM LU·∫¨T (CASCADING DROPDOWN - B·ªé C·ªòT NOTE) ===== -->
            <div class="tab-pane" id="search-tab">
                <div class="tab-header">
                    <h2>üîé T√¨m Lu·∫≠t (Cascading Filter)</h2>
                </div>

                <div class="tab-content">
                    <!-- Cascading Filters Container -->
                    <div class="cascading-filters" id="cascadingFilters">
                        <div class="placeholder">
                            ‚¨ÜÔ∏è Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc ƒë·ªÉ b·∫Øt ƒë·∫ßu
                        </div>
                    </div>

                    <!-- N√∫t T√¨m Ki·∫øm -->
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="searchBtn">
                            <span>üîç T√¨m Lu·∫≠t</span>
                        </button>
                        <button class="btn btn-secondary" id="clearSearchBtn">
                            <span>üîÑ X√≥a B·ªô L·ªçc</span>
                        </button>
                    </div>

                    <!-- K·∫øt Qu·∫£ T√¨m Ki·∫øm -->
                    <div id="searchResults" style="margin-top: 20px;">
                        <!-- S·∫Ω hi·ªÉn th·ªã k·∫øt qu·∫£ ·ªü ƒë√¢y -->
                    </div>
                </div>
            </div>

            <!-- ===== TAB 3: SUY DI·ªÑN (HI·ªÇN TH·ªä NOTE CHI TI·∫æT) ===== -->
            <div class="tab-pane" id="inference-tab">
                <div class="tab-header">
                    <h2>üß† Suy Di·ªÖn Logic</h2>
                </div>

                <div class="tab-content">
                    <!-- Ph∆∞∆°ng Ph√°p Suy Di·ªÖn -->
                    <div class="method-section">
                        <h3>üéØ Ph∆∞∆°ng Ph√°p Suy Di·ªÖn</h3>
                        <div class="method-buttons">
                            <div class="method-btn active" data-method="forward">
                                <span>‚û°Ô∏è</span>
                                <span>Suy Di·ªÖn Ti·∫øn</span>
                                <small>(Forward Chaining)</small>
                            </div>
                            <div class="method-btn" data-method="backward">
                                <span>‚¨ÖÔ∏è</span>
                                <span>Suy Di·ªÖn L√πi</span>
                                <small>(Backward Chaining)</small>
                            </div>
                        </div>
                        <input type="hidden" id="inferenceMethod" value="forward">
                    </div>

                    <!-- Input Facts (t·ª´ T√¨m Lu·∫≠t) -->
                    <div class="input-section">
                        <h3>üìç Facts (S·ª± Ki·ªán)</h3>
                        <label>C√°c ƒëi·ªÅu ki·ªán ƒë√£ ch·ªçn t·ª´ tab T√¨m Lu·∫≠t:</label>
                        <div class="facts-box" id="factsBox">
                            <span class="placeholder">Ch∆∞a c√≥ facts. Vui l√≤ng ch·ªçn t·ª´ tab "T√¨m Lu·∫≠t"</span>
                        </div>
                        <textarea id="factsInput" class="form-control" rows="2" placeholder="Ho·∫∑c nh·∫≠p th·ªß c√¥ng (VD: TYPE=food, PRODUCT=black pepper)" disabled></textarea>
                    </div>

                    <!-- Input Goals -->
                    <div class="input-section">
                        <h3>üéØ Goals (M·ª•c Ti√™u Suy Di·ªÖn)</h3>
                        <div class="form-group">
                            <label>Nh·∫≠p m·ª•c ti√™u c·∫ßn suy di·ªÖn:</label>
                            <textarea id="goalsInput" class="form-control" rows="3" placeholder="V√≠ d·ª•: RISK_DECISION=serious, SEVERITY=high" required></textarea>
                            <small>üí° Nh·∫≠p 1 ho·∫∑c nhi·ªÅu goal, c√°ch nhau b·ªüi d·∫•u ph·∫©y (,)</small>
                        </div>

                        <div class="form-group">
                            <label>üìã Tips:</label>
                            <ul class="tips">
                                <li>Suy Di·ªÖn Ti·∫øn: B·∫Øt ƒë·∫ßu t·ª´ Facts ‚Üí T√¨m Goals</li>
                                <li>Suy Di·ªÖn L√πi: B·∫Øt ƒë·∫ßu t·ª´ Goals ‚Üí T√¨m Facts</li>
                                <li>S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng: KEY=value</li>
                            </ul>
                        </div>

                        <button class="btn btn-success" id="inferenceBtn">
                            <span>üöÄ Ch·∫°y Suy Di·ªÖn</span>
                        </button>
                    </div>

                    <!-- K·∫øt Qu·∫£ Suy Di·ªÖn -->
                    <div id="inferenceResults" style="margin-top: 20px;">
                        <!-- S·∫Ω hi·ªÉn th·ªã k·∫øt qu·∫£ ·ªü ƒë√¢y -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        const BASE_URL = 'http://localhost:5000';
        let selectedCascadingValues = {};
        let currentFacts = [];
        let cascadingFields = [];
        let allAvailableValues = {};

        // ============ TAB NAVIGATION ============
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                item.classList.add('active');
                const tabName = item.getAttribute('data-tab');
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // ============ METHOD SELECTION ============
        document.querySelectorAll('.method-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('inferenceMethod').value = btn.getAttribute('data-method');
            });
        });

        // ============ FILE UPLOAD ============
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadMessage = document.getElementById('uploadMessage');

        uploadBtn.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#d5e8f7';
            uploadArea.style.borderColor = '#2196F3';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = '';
            uploadArea.style.borderColor = '';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            uploadArea.style.borderColor = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                uploadFile();
            }
        });

        fileInput.addEventListener('change', uploadFile);

        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) return;

            uploadMessage.innerHTML = '<div class="status loading">‚è≥ ƒêang t·∫£i file...</div>';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${BASE_URL}/upload_rasff`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log('Upload response:', data);

                if (data.success) {
                    uploadMessage.innerHTML = `
                        <div class="status success">
                            ‚úÖ ${data.message}
                            <br><small>T√¨m th·∫•y ${data.rules_count} lu·∫≠t | ${data.keys_count} tr∆∞·ªùng</small>
                        </div>
                    `;
                    
                    await loadAllCascadingFilters();
                } else {
                    uploadMessage.innerHTML = `<div class="status error">‚ùå ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Upload error:', error);
                uploadMessage.innerHTML = `<div class="status error">‚ùå L·ªói: ${error.message}</div>`;
            }
        }

        // ============ CASCADING FILTERS - HI·ªÇN TH·ªä T·∫§T C·∫¢ ============
        async function loadAllCascadingFilters() {
            try {
                console.log('Loading all cascading filters...');
                const response = await fetch(`${BASE_URL}/get_keys_rasff`);
                const data = await response.json();
                console.log('Get keys response:', data);

                if (data.success && data.cascadingFields) {
                    cascadingFields = data.cascadingFields;
                    allAvailableValues = data.values_by_key;
                    
                    const container = document.getElementById('cascadingFilters');
                    container.innerHTML = '';
                    selectedCascadingValues = {};

                    // ‚úÖ T·∫†O T·∫§T C·∫¢ DROPDOWN C√ôNG L√öC
                    cascadingFields.forEach((field, index) => {
                        const values = allAvailableValues[field] || [];
                        const fieldDiv = createFieldDropdown(field, values, index);
                        container.appendChild(fieldDiv);
                    });

                    console.log('‚úÖ All dropdowns created');
                } else {
                    console.error('Failed to load filters:', data);
                    document.getElementById('cascadingFilters').innerHTML = 
                        '<div class="placeholder">‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c b·ªô l·ªçc</div>';
                }
            } catch (error) {
                console.error('Error loading filters:', error);
                document.getElementById('cascadingFilters').innerHTML = 
                    '<div class="placeholder">‚ùå L·ªói t·∫£i b·ªô l·ªçc</div>';
            }
        }

        function createFieldDropdown(fieldName, values, fieldIndex) {
            const div = document.createElement('div');
            div.className = 'cascading-field';
            div.innerHTML = `
                <label>${fieldName}</label>
                <select id="select_${fieldName}" class="cascading-select" data-field="${fieldName}">
                    <option value="">-- Ch·ªçn ${fieldName} --</option>
                    ${values.map(v => `<option value="${v}">${v}</option>`).join('')}
                </select>
            `;

            const select = div.querySelector(`#select_${fieldName}`);
            select.addEventListener('change', async (e) => {
                await handleFieldChange(fieldName, e.target.value);
            });

            return div;
        }

        async function handleFieldChange(fieldName, selectedValue) {
            console.log(`Field changed: ${fieldName} = ${selectedValue}`);

            // C·∫≠p nh·∫≠t selectedCascadingValues
            if (selectedValue) {
                selectedCascadingValues[fieldName] = selectedValue;
            } else {
                delete selectedCascadingValues[fieldName];
            }

            console.log('Current selected values:', selectedCascadingValues);

            // ‚úÖ G·ªåI API ƒê·ªÇ L·∫§Y AVAILABLE VALUES CHO T·∫§T C·∫¢ FIELDS
            try {
                const response = await fetch(`${BASE_URL}/get_all_filtered_values`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selectedValues: selectedCascadingValues })
                });

                const data = await response.json();
                console.log('Filtered values response:', data);

                if (data.success && data.availableValuesByField) {
                    // ‚úÖ C·∫¨P NH·∫¨T T·∫§T C·∫¢ DROPDOWN V·ªöI AVAILABLE VALUES
                    updateAllDropdowns(data.availableValuesByField);
                }
            } catch (error) {
                console.error('Error fetching filtered values:', error);
            }
        }

        function updateAllDropdowns(availableValuesByField) {
            console.log('Updating all dropdowns with filtered values...');

            cascadingFields.forEach(field => {
                const select = document.getElementById(`select_${field}`);
                if (!select) return;

                const availableValues = availableValuesByField[field] || [];
                const currentValue = selectedCascadingValues[field] || '';

                console.log(`Updating ${field}: ${availableValues.length} values available`);

                // X√≥a options c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
                while (select.options.length > 1) {
                    select.remove(1);
                }

                // Th√™m options m·ªõi
                availableValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    if (value === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                // Disable n·∫øu kh√¥ng c√≥ options
                select.disabled = availableValues.length === 0;
            });
        }

        // ============ SEARCH REGULATIONS (B·ªé C·ªòT NOTE) ============
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const facts = Object.entries(selectedCascadingValues).map(([k, v]) => `${k}=${v}`);
            console.log('Search button clicked, facts:', facts);

            if (facts.length === 0) {
                document.getElementById('searchResults').innerHTML = 
                    '<div class="status error">‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt gi√° tr·ªã</div>';
                return;
            }

            currentFacts = facts;

            try {
                const response = await fetch(`${BASE_URL}/search_rasff`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ facts })
                });

                const data = await response.json();
                console.log('Search response:', data);
                const resultsDiv = document.getElementById('searchResults');

                if (data.success && data.count > 0) {
                    let rulesHtml = `
                        <div class="results-box">
                            <h3>‚úÖ T√¨m th·∫•y ${data.count} lu·∫≠t:</h3>
                            <table class="rules-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ƒêi·ªÅu Ki·ªán (IF)</th>
                                        <th>K·∫øt Lu·∫≠n (THEN)</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    data.rules.forEach(rule => {
                        rulesHtml += `
                            <tr>
                                <td><strong>${rule.id}</strong></td>
                                <td style="font-size: 12px; color: #666;">${rule.veTrai}</td>
                                <td><strong style="color: #27ae60;">${rule.vePhai}</strong></td>
                            </tr>
                        `;
                    });

                    rulesHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;

                    resultsDiv.innerHTML = rulesHtml;

                    document.getElementById('factsInput').value = facts.join(', ');
                    updateFactsDisplay(facts);
                } else {
                    resultsDiv.innerHTML = `<div class="status error">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y lu·∫≠t n√†o ph√π h·ª£p</div>`;
                }
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('searchResults').innerHTML = 
                    `<div class="status error">‚ùå L·ªói: ${error.message}</div>`;
            }
        });

        // N√∫t X√≥a B·ªô L·ªçc
        document.getElementById('clearSearchBtn').addEventListener('click', () => {
            console.log('Clear filters clicked');
            selectedCascadingValues = {};
            currentFacts = [];
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('factsInput').value = '';
            document.getElementById('factsBox').innerHTML = 
                '<span class="placeholder">Ch∆∞a c√≥ facts. Vui l√≤ng ch·ªçn t·ª´ tab "T√¨m Lu·∫≠t"</span>';
            
            loadAllCascadingFilters();
        });

        // ============ UPDATE FACTS DISPLAY ============
        function updateFactsDisplay(facts) {
            const factsBox = document.getElementById('factsBox');
            if (facts.length > 0) {
                factsBox.innerHTML = facts.map(fact => 
                    `<span class="fact-tag">${fact}</span>`
                ).join('');
            } else {
                factsBox.innerHTML = '<span class="placeholder">Ch∆∞a c√≥ facts</span>';
            }
        }

        // ============ INFERENCE (HI·ªÇN TH·ªä NOTE CHI TI·∫æT) ============
        document.getElementById('inferenceBtn').addEventListener('click', async () => {
            const method = document.getElementById('inferenceMethod').value;
            const goalsStr = document.getElementById('goalsInput').value.trim();

            console.log(`Inference clicked: method=${method}, goals=${goalsStr}`);

            if (!goalsStr) {
                document.getElementById('inferenceResults').innerHTML = 
                    '<div class="status error">‚ùå Vui l√≤ng nh·∫≠p Goal</div>';
                return;
            }

            const goals = goalsStr.split(',').map(g => g.trim());
            const initialFacts = currentFacts;

            const endpoint = method === 'forward' ? 
                `${BASE_URL}/forward_inference_rasff` : 
                `${BASE_URL}/backward_inference_rasff`;

            try {
                document.getElementById('inferenceResults').innerHTML = 
                    '<div class="status loading">‚è≥ ƒêang suy di·ªÖn...</div>';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goals, initial_facts: initialFacts })
                });

                const data = await response.json();
                console.log('Inference response:', data);
                const resultsDiv = document.getElementById('inferenceResults');

                if (data.success) {
                    let resultsHtml = `
                        <div class="results-section">
                            <div class="inference-status status success">
                                ‚úÖ Suy di·ªÖn ${method === 'forward' ? 'Ti·∫øn' : 'L√πi'} th√†nh c√¥ng
                                <br><small>${data.status}</small>
                            </div>

                            <div class="results-box">
                                <h3>üìã C√°c B∆∞·ªõc Suy Di·ªÖn:</h3>
                    `;

                    if (data.explanation && data.explanation.length > 0) {
                        data.explanation.forEach((step, idx) => {
                            let stepHtml = `
                                <div class="step-box">
                                    <div class="step-header">
                                        B∆∞·ªõc ${idx + 1}: ${step.type || 'Chi ti·∫øt'}
                                        ${step.rule_id ? ` - Lu·∫≠t #${step.rule_id}` : ''}
                                    </div>
                                    <div class="step-body">
                            `;

                            // Hi·ªÉn th·ªã description
                            if (step.description) {
                                stepHtml += `<p>${step.description}</p>`;
                            }

                            // Hi·ªÉn th·ªã premises v√† conclusion (forward)
                            if (step.premises) {
                                stepHtml += `
                                    <div style="margin: 10px 0;">
                                        <strong>ƒêi·ªÅu ki·ªán (IF):</strong>
                                        <div style="margin-left: 15px; color: #666; font-size: 12px;">
                                            ${step.premises.join(', ')}
                                        </div>
                                    </div>
                                `;
                            }

                            if (step.conclusion) {
                                stepHtml += `
                                    <div style="margin: 10px 0;">
                                        <strong>K·∫øt lu·∫≠n (THEN):</strong>
                                        <div style="margin-left: 15px; color: #27ae60; font-weight: 600;">
                                            ${step.conclusion}
                                        </div>
                                    </div>
                                `;
                            }

                            // ‚úÖ HI·ªÇN TH·ªä NOTE CHI TI·∫æT
                            if (step.note && step.note !== 'N/A') {
                                stepHtml += `
                                    <div class="note-box">
                                        <div class="note-header">üìù Di·ªÖn Gi·∫£i Chi Ti·∫øt:</div>
                                        <div class="note-content">${step.note.replace(/\n/g, '<br>')}</div>
                                    </div>
                                `;
                            }

                            // Hi·ªÉn th·ªã Ve_Trai v√† Ve_Phai (backward)
                            if (step.ve_trai) {
                                stepHtml += `
                                    <div style="margin: 10px 0;">
                                        <strong>ƒêi·ªÅu ki·ªán (IF):</strong>
                                        <div style="margin-left: 15px; color: #666; font-size: 12px;">
                                            ${step.ve_trai}
                                        </div>
                                    </div>
                                `;
                            }

                            if (step.ve_phai) {
                                stepHtml += `
                                    <div style="margin: 10px 0;">
                                        <strong>K·∫øt lu·∫≠n (THEN):</strong>
                                        <div style="margin-left: 15px; color: #27ae60; font-weight: 600;">
                                            ${step.ve_phai}
                                        </div>
                                    </div>
                                `;
                            }

                            // Hi·ªÉn th·ªã reason
                            if (step.reason) {
                                stepHtml += `<p style="color: #e67e22; margin-top: 10px;"><em>${step.reason}</em></p>`;
                            }

                            stepHtml += `
                                    </div>
                                </div>
                            `;

                            resultsHtml += stepHtml;
                        });
                    } else {
                        resultsHtml += '<p class="placeholder">Kh√¥ng c√≥ b∆∞·ªõc suy di·ªÖn</p>';
                    }

                    if (data.working_memory && data.working_memory.length > 0) {
                        resultsHtml += `
                            <h3 style="margin-top: 20px;">üíæ Working Memory (T·∫•t C·∫£ Facts):</h3>
                            <div class="facts-box">
                                ${data.working_memory.map(fact => 
                                    `<span class="fact-tag">${fact}</span>`
                                ).join('')}
                            </div>
                        `;
                    }

                    resultsHtml += '</div></div>';
                    resultsDiv.innerHTML = resultsHtml;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="status error">
                            ‚ùå Suy di·ªÖn kh√¥ng th√†nh c√¥ng
                            <br><small>${data.status}</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Inference error:', error);
                document.getElementById('inferenceResults').innerHTML = 
                    `<div class="status error">‚ùå L·ªói: ${error.message}</div>`;
            }
        });

        window.addEventListener('load', () => {
            console.log('Page loaded, BASE_URL:', BASE_URL);
        });
    </script>
</body>
</html>
