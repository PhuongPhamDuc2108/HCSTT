<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RASFF Risk Analysis System</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div class="wrapper">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>RASFF PRO</h1>
                <p>Risk Assessment AI</p>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" id="nav-search" onclick="switchTab('search')">
                    <i class="fas fa-filter"></i> <span>Nhập Dữ Liệu</span>
                </div>
                <div class="nav-item" id="nav-dashboard" onclick="switchTab('dashboard')">
                    <i class="fas fa-chart-pie"></i> <span>Dashboard</span>
                </div>
                <div class="nav-item" id="nav-inference" onclick="switchTab('inference')">
                    <i class="fas fa-radiation"></i> <span>Kết Quả Phân Tích</span>
                </div>
            </nav>
            <div class="sidebar-footer"><p>© 2025 RASFF System</p></div>
        </div>

        <div class="main-content">
            <div class="tab-pane active" id="search-tab">
                <div class="tab-header"><h2>Chọn Thông Số Đầu Vào</h2></div>
                <div class="tab-content">
                    <div id="loading-box" class="status loading">
                        <i class="fas fa-spinner fa-spin"></i> Đang khởi tạo hệ thống...
                    </div>
                    <div class="input-section">
                        <h3 class="section-title">Bộ lọc dữ liệu</h3>
                        <div class="cascading-filters" id="cascadingFilters"></div>
                    </div>
                    <div class="action-bar">
                        <button class="btn btn-secondary" onclick="window.location.reload()">
                            <i class="fas fa-sync-alt"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="confirmAndInfer()">
                            <i class="fas fa-search"></i> Phân Tích Rủi Ro
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="dashboard-tab">
                <div class="tab-header"><h2>Thống Kê & Tổng Quan Số Liệu</h2></div>
                <div class="tab-content">
                    <div class="dashboard-grid">
                        <div class="dash-card full-width">
                            <h3><i class="fas fa-globe-americas"></i> Bản Đồ Phân Bố Cảnh Báo Toàn Cầu</h3>
                            <div id="mapChart" style="width:100%; height:550px;"></div>
                        </div>
                        <div class="dash-card">
                            <h3><i class="fas fa-boxes"></i> Top Loại Sản Phẩm (Giảm dần)</h3>
                            <div class="chart-container"><canvas id="prodCatChart"></canvas></div>
                        </div>
                        <div class="dash-card">
                            <h3><i class="fas fa-biohazard"></i> Top Loại Mối Nguy (Giảm dần)</h3>
                            <div class="chart-container"><canvas id="hazardChart"></canvas></div>
                        </div>
                        <div class="dash-card full-width">
                            <h3><i class="fas fa-exclamation-circle"></i> Top 10 Sản Phẩm Có Nhiều Cảnh Báo Nhất</h3>
                            <div class="table-responsive">
                                <table class="data-table" id="topProdTable">
                                    <thead><tr><th>Sản Phẩm</th><th>Số Lượng Cảnh Báo</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="inference-tab">
                <div class="tab-header"><h2> Kết Quả & Đánh Giá Rủi Ro</h2></div>
                <div class="tab-content">
                    <div class="input-section">
                        <h3>Thông tin đầu vào:</h3>
                        <div class="facts-box" id="factsBox"></div>
                    </div>
                    <div class="inference-action">
                        <button class="btn btn-secondary" onclick="switchTab('search')">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </button>
                        <button class="btn btn-success" onclick="runInference()">
                            <i class="fas fa-sync"></i> Chạy Lại
                        </button>
                    </div>
                    <div id="inferenceResults" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://127.0.0.1:5000';
        const ORDERED_FIELDS = ['NOT_COUNTRY', 'TYPE', 'PROD_CAT', 'PRODUCT', 'HAZARDS_CAT', 'HAZARDS'];
        let selectedValues = {};
        let prodChartInstance = null;
        let hazardChartInstance = null;

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch(`${BASE_URL}/get_initial_data`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('loading-box').style.display = 'none';
                    initCascadingFilters(data.values_by_key);
                    loadDashboardData();
                } else {
                    alert("Lỗi tải dữ liệu server!");
                }
            } catch (e) {
                document.getElementById('loading-box').innerHTML = `❌ Lỗi kết nối: ${e.message}`;
                document.getElementById('loading-box').classList.add('error');
            }
        });

        function initCascadingFilters(initialData) {
            const container = document.getElementById('cascadingFilters');
            container.innerHTML = '';
            selectedValues = {};
            ORDERED_FIELDS.forEach((field, idx) => {
                const div = document.createElement('div');
                div.className = 'cascading-field';
                let label = field === 'NOT_COUNTRY' ? 'QUỐC GIA' : field;
                div.innerHTML = `
                    <label>${label}</label>
                    <select id="select_${field}" class="cascading-select" onchange="handleSelection('${field}', this.value)" ${idx === 0 ? '' : 'disabled'}>
                        <option value="">-- Chọn --</option>
                    </select>
                `;
                container.appendChild(div);
            });
            updateDropdownsUI(initialData);
        }

        async function handleSelection(field, value) {
            if (value) selectedValues[field] = value;
            else delete selectedValues[field];
            let startReset = false;
            ORDERED_FIELDS.forEach(f => {
                if (startReset) {
                    delete selectedValues[f];
                    const sel = document.getElementById(`select_${f}`);
                    if(sel) { sel.value = ""; sel.innerHTML = '<option value="">-- Chọn --</option>'; sel.disabled = true; }
                }
                if (f === field) startReset = true;
            });
            try {
                const res = await fetch(`${BASE_URL}/get_all_filtered_values`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selectedValues })
                });
                const data = await res.json();
                if (data.success) updateDropdownsUI(data.availableValuesByField);
            } catch (e) { console.error(e); }
        }

        function updateDropdownsUI(availableValues) {
            let enableNext = true;
            ORDERED_FIELDS.forEach(field => {
                const select = document.getElementById(`select_${field}`);
                if (!select) return;
                const currentVal = selectedValues[field] || "";
                if (enableNext) {
                    select.disabled = false;
                    const opts = availableValues[field] || [];
                    while (select.options.length > 1) select.remove(1);
                    opts.forEach(val => {
                        const opt = document.createElement('option');
                        opt.value = val;
                        opt.innerText = val;
                        if (val === currentVal) opt.selected = true;
                        select.appendChild(opt);
                    });
                } else {
                    select.disabled = true;
                }
                if (!currentVal) enableNext = false;
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById('nav-' + tabName).classList.add('active');
            if(tabName === 'dashboard') setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
        }

        function getRiskInfo(riskStr) {
            const num = parseFloat(riskStr.replace('%', ''));
            if (isNaN(num)) return { class: 'risk-unknown', label: 'Không xác định' };
            if (num >= 80) return { class: 'risk-high', label: 'RẤT CAO (NGUY HIỂM)' };
            if (num >= 50) return { class: 'risk-medium', label: 'TRUNG BÌNH' };
            return { class: 'risk-low', label: 'THẤP (AN TOÀN)' };
        }

        async function confirmAndInfer() {
            const facts = [];
            ORDERED_FIELDS.forEach(f => {
                if (selectedValues[f]) facts.push(`${f}=${selectedValues[f]}`);
            });
            if (facts.length === 0) { alert("Vui lòng chọn ít nhất quốc gia!"); return; }
            document.getElementById('factsBox').innerHTML = facts.map(f => `<span class="fact-tag">${f}</span>`).join('');
            switchTab('inference');
            runInference(facts);
        }

        async function runInference(factsInput = null) {
            const facts = factsInput || [];
            const resDiv = document.getElementById('inferenceResults');
            resDiv.innerHTML = '<div class="status loading"><i class="fas fa-circle-notch fa-spin"></i> Đang phân tích kịch bản...</div>';
            
            if (!factsInput) {
                ORDERED_FIELDS.forEach(f => { if (selectedValues[f]) facts.push(`${f}=${selectedValues[f]}`); });
            }
            
            try {
                const res = await fetch(`${BASE_URL}/forward_inference_rasff`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initial_facts: facts })
                });
                const data = await res.json();
                console.log("API Response:", data); // Check console

                if (data.success && data.results.length > 0) {
                    let html = '';
                    data.results.forEach((item, idx) => {
                        const riskVal = item.risk || '0%';
                        const riskInfo = getRiskInfo(riskVal);
                        const distVal = item.distribution || 'N/A';
                        // [FIX] Hiển thị action taken
                        const actionVal = item.action_taken || 'Chưa có thông tin';
                        const note = item.note ? item.note.replace(/\n/g, '<br>') : 'Không có ghi chú.';
                        
                        html += `
                            <div class="result-card ${riskInfo.class}">
                                <div class="result-card-header">
                                    <span><i class="fas fa-exclamation-triangle"></i> KỊCH BẢN #${idx+1}</span>
                                    <span class="risk-badge">RỦI RO: ${riskVal}</span>
                                </div>
                                <div class="result-body">
                                    <div class="conclusion-box">
                                        <div class="label">DỰ BÁO / HÀNH ĐỘNG:</div>
                                        <div class="value">${item.conclusion}</div>
                                    </div>
                                    
                                    <div class="action-box">
                                        <div class="label"><i class="fas fa-clipboard-check"></i> BIỆN PHÁP ĐÃ XỬ LÝ (ACTION TAKEN):</div>
                                        <div class="value">${actionVal}</div>
                                    </div>

                                    <div class="dist-box">
                                        <div class="label"><i class="fas fa-tasks"></i> TRẠNG THÁI PHÂN PHỐI:</div>
                                        <div class="value">${distVal}</div>
                                    </div>

                                    <div class="note-box">
                                        <div class="label"><i class="fas fa-info-circle"></i> GHI CHÚ:</div>
                                        <div class="value">${note}</div>
                                    </div>
                                </div>
                            </div>`;
                    });
                    resDiv.innerHTML = html;
                } else {
                    resDiv.innerHTML = '<div class="status error">Không tìm thấy dữ liệu phù hợp.</div>';
                }
            } catch (e) {
                resDiv.innerHTML = `<div class="status error">Lỗi hệ thống: ${e.message}</div>`;
            }
        }

        async function loadDashboardData() {
            try {
                const res = await fetch(`${BASE_URL}/get_dashboard_statistics`);
                const data = await res.json();
                if (data.success && data.stats) {
                    renderMap(data.stats.country_counts);
                    renderCharts(data.stats);
                    renderTopTable(data.stats.top_products_list);
                }
            } catch (e) { console.error("Dashboard load error:", e); }
        }

        // Các hàm render biểu đồ giữ nguyên như cũ...
        function renderMap(countryData) {
            const countries = Object.keys(countryData);
            const counts = Object.values(countryData);
            const data = [{ type: 'choropleth', locationmode: 'country names', locations: countries, z: counts, text: countries, colorscale: 'Reds', autocolorscale: false, reversescale: false, marker: { line: { color: 'rgb(255,255,255)', width: 1 } }, colorbar: { title: 'Số cảnh báo', thickness: 15 } }];
            const layout = { title: false, geo: { scope: 'world', showframe: false, showcoastlines: true, showcountries: true, countrycolor: 'rgb(200,200,200)', countrywidth: 0.5, showland: true, landcolor: 'rgb(245, 245, 245)', showocean: true, oceancolor: 'rgb(225, 240, 255)', projection: { type: 'natural earth' } }, margin: {l:0, r:0, b:0, t:0}, height: 550 };
            Plotly.newPlot('mapChart', data, layout, {responsive: true, displayModeBar: false});
        }

        function renderCharts(stats) {
            if (prodChartInstance) prodChartInstance.destroy();
            if (hazardChartInstance) hazardChartInstance.destroy();
            prodChartInstance = new Chart(document.getElementById('prodCatChart'), { type: 'doughnut', data: { labels: stats.prod_cat_stats.labels, datasets: [{ data: stats.prod_cat_stats.values, backgroundColor: ['#00cec9', '#0984e3', '#6c5ce7', '#fdcb6e', '#e17055', '#d63031', '#e84393', '#00b894', '#ffeaa7'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: {boxWidth: 10, font:{size:10}} } } } });
            hazardChartInstance = new Chart(document.getElementById('hazardChart'), { type: 'bar', data: { labels: stats.hazard_stats.labels, datasets: [{ label: 'Số cảnh báo', data: stats.hazard_stats.values, backgroundColor: '#ff7675' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } });
        }

        function renderTopTable(topProductsList) {
            const tbody = document.querySelector('#topProdTable tbody');
            tbody.innerHTML = '';
            topProductsList.forEach((item, idx) => {
                const row = `<tr><td><span class="rank-badge">${idx+1}</span> ${item.name}</td><td style="font-weight:bold; color:#d63031;">${item.count}</td></tr>`;
                tbody.innerHTML += row;
            });
        }
    </script>
</body>
</html>