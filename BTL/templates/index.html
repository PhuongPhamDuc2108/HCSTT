<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RASFF Risk Analysis System</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="wrapper">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>RASFF PRO</h1>
                <p>Risk Assessment AI</p>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" id="nav-search" onclick="switchTab('search')">
                    <i class="fas fa-filter"></i> <span>Nhập Dữ Liệu</span>
                </div>
                <div class="nav-item" id="nav-inference" onclick="switchTab('inference')">
                    <i class="fas fa-radiation"></i> <span>Kết Quả Phân Tích</span>
                </div>
            </nav>
            <div class="sidebar-footer"><p>© 2025 RASFF System</p></div>
        </div>

        <div class="main-content">
            <div class="tab-pane active" id="search-tab">
                <div class="tab-header"><h2>Chọn Thông Số Đầu Vào</h2></div>
                <div class="tab-content">
                    <div id="loading-box" class="status loading">
                        <i class="fas fa-spinner fa-spin"></i> Đang khởi tạo hệ thống...
                    </div>
                    <div class="input-section">
                        <h3 class="section-title">Bộ lọc dữ liệu</h3>
                        <div class="cascading-filters" id="cascadingFilters"></div>
                    </div>
                    <div class="action-bar">
                        <button class="btn btn-secondary" onclick="window.location.reload()">
                            <i class="fas fa-sync-alt"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="confirmAndInfer()">
                            <i class="fas fa-search"></i> Phân Tích Rủi Ro
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="inference-tab">
                <div class="tab-header"><h2> Kết Quả & Đánh Giá Rủi Ro</h2></div>
                <div class="tab-content">
                    <div class="input-section">
                        <h3>Thông tin đầu vào:</h3>
                        <div class="facts-box" id="factsBox"></div>
                    </div>
                    <div class="inference-action">
                        <button class="btn btn-secondary" onclick="switchTab('search')">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </button>
                        <button class="btn btn-success" onclick="runInference()">
                            <i class="fas fa-sync"></i> Chạy Lại
                        </button>
                    </div>
                    <div id="inferenceResults" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://127.0.0.1:5000';
        const ORDERED_FIELDS = ['NOT_COUNTRY', 'TYPE', 'PROD_CAT', 'PRODUCT', 'HAZARDS_CAT', 'HAZARDS'];
        let selectedValues = {};

        // KHỞI TẠO
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch(`${BASE_URL}/get_initial_data`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('loading-box').style.display = 'none';
                    initCascadingFilters(data.values_by_key);
                } else {
                    alert("Lỗi tải dữ liệu server!");
                }
            } catch (e) {
                document.getElementById('loading-box').innerHTML = `❌ Lỗi kết nối: ${e.message}`;
                document.getElementById('loading-box').classList.add('error');
            }
        });

        // UI: TẠO DROPDOWN
        function initCascadingFilters(initialData) {
            const container = document.getElementById('cascadingFilters');
            container.innerHTML = '';
            selectedValues = {};

            ORDERED_FIELDS.forEach((field, idx) => {
                const div = document.createElement('div');
                div.className = 'cascading-field';
                let label = field === 'NOT_COUNTRY' ? 'QUỐC GIA' : field;
                
                div.innerHTML = `
                    <label>${label}</label>
                    <select id="select_${field}" class="cascading-select" onchange="handleSelection('${field}', this.value)" ${idx === 0 ? '' : 'disabled'}>
                        <option value="">-- Chọn --</option>
                    </select>
                `;
                container.appendChild(div);
            });
            updateDropdownsUI(initialData);
        }

        // LOGIC: XỬ LÝ CHỌN DROPDOWN
        async function handleSelection(field, value) {
            if (value) selectedValues[field] = value;
            else delete selectedValues[field];

            // Reset các trường phía sau
            let startReset = false;
            ORDERED_FIELDS.forEach(f => {
                if (startReset) {
                    delete selectedValues[f];
                    const sel = document.getElementById(`select_${f}`);
                    if(sel) { sel.value = ""; sel.innerHTML = '<option value="">-- Chọn --</option>'; sel.disabled = true; }
                }
                if (f === field) startReset = true;
            });

            // Gọi API lấy dữ liệu lọc mới
            try {
                const res = await fetch(`${BASE_URL}/get_all_filtered_values`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selectedValues })
                });
                const data = await res.json();
                if (data.success) updateDropdownsUI(data.availableValuesByField);
            } catch (e) { console.error(e); }
        }

        function updateDropdownsUI(availableValues) {
            let enableNext = true;
            ORDERED_FIELDS.forEach(field => {
                const select = document.getElementById(`select_${field}`);
                if (!select) return;
                
                const currentVal = selectedValues[field] || "";
                
                if (enableNext) {
                    select.disabled = false;
                    const opts = availableValues[field] || [];
                    // Giữ lại option hiện tại nếu có, cập nhật list option
                    while (select.options.length > 1) select.remove(1);
                    opts.forEach(val => {
                        const opt = document.createElement('option');
                        opt.value = val;
                        opt.innerText = val;
                        if (val === currentVal) opt.selected = true;
                        select.appendChild(opt);
                    });
                } else {
                    select.disabled = true;
                }
                if (!currentVal) enableNext = false;
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById('nav-' + tabName).classList.add('active');
        }

        // LOGIC: TÍNH TOÁN MÀU SẮC RỦI RO
        function getRiskInfo(riskStr) {
            const num = parseFloat(riskStr.replace('%', ''));
            if (isNaN(num)) return { class: 'risk-unknown', label: 'Không xác định' };
            
            if (num >= 80) return { class: 'risk-high', label: 'RẤT CAO (NGUY HIỂM)' };
            if (num >= 50) return { class: 'risk-medium', label: 'TRUNG BÌNH' };
            return { class: 'risk-low', label: 'THẤP (AN TOÀN)' };
        }

        async function confirmAndInfer() {
            const facts = [];
            ORDERED_FIELDS.forEach(f => {
                if (selectedValues[f]) facts.push(`${f}=${selectedValues[f]}`);
            });

            if (facts.length === 0) { alert("Vui lòng chọn ít nhất quốc gia!"); return; }
            
            document.getElementById('factsBox').innerHTML = facts.map(f => `<span class="fact-tag">${f}</span>`).join('');
            switchTab('inference');
            runInference(facts);
        }

        async function runInference(factsInput = null) {
            const facts = factsInput || [];
            const resDiv = document.getElementById('inferenceResults');
            resDiv.innerHTML = '<div class="status loading"><i class="fas fa-circle-notch fa-spin"></i> Đang phân tích kịch bản...</div>';

            if (!factsInput) {
                ORDERED_FIELDS.forEach(f => { if (selectedValues[f]) facts.push(`${f}=${selectedValues[f]}`); });
            }

            try {
                const res = await fetch(`${BASE_URL}/forward_inference_rasff`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initial_facts: facts })
                });
                const data = await res.json();

                if (data.success && data.results.length > 0) {
                    let html = '';
                    data.results.forEach((item, idx) => {
                        const riskVal = item.risk || '0%';
                        const riskInfo = getRiskInfo(riskVal);
                        const distVal = item.distribution || 'N/A';
                        const note = item.note ? item.note.replace(/\n/g, '<br>') : 'Không có ghi chú.';

                        html += `
                            <div class="result-card ${riskInfo.class}">
                                <div class="result-card-header">
                                    <span><i class="fas fa-exclamation-triangle"></i> KỊCH BẢN #${idx+1}</span>
                                    <span class="risk-badge">RỦI RO: ${riskVal}</span>
                                </div>
                                <div class="result-body">
                                    <div class="conclusion-box">
                                        <div class="label">DỰ BÁO / HÀNH ĐỘNG:</div>
                                        <div class="value">${item.conclusion}</div>
                                    </div>
                                    
                                    <div class="dist-box">
                                        <div class="label"><i class="fas fa-tasks"></i> TRẠNG THÁI XỬ LÝ PHÂN PHỐI (DISTRIBUTION STAT):</div>
                                        <div class="value">${distVal}</div>
                                    </div>

                                    <div class="note-box">
                                        <div class="label"><i class="fas fa-info-circle"></i> GHI CHÚ CHI TIẾT:</div>
                                        <div class="value">${note}</div>
                                    </div>
                                </div>
                            </div>`;
                    });
                    resDiv.innerHTML = html;
                } else {
                    resDiv.innerHTML = '<div class="status error">Không tìm thấy dữ liệu phù hợp.</div>';
                }
            } catch (e) {
                resDiv.innerHTML = `<div class="status error">Lỗi hệ thống: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>